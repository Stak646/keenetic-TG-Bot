#!/bin/sh
export PATH="/opt/sbin:/opt/bin:/usr/sbin:/usr/bin:/sbin:/bin:$PATH"

BOT_DIR="/opt/etc/keenetic-tg-bot"
MAIN="$BOT_DIR/Main.py"
LEGACY="$BOT_DIR/bot.py"

CONFIG1="$BOT_DIR/config/config.json"
CONFIG2="$BOT_DIR/config.json"

PIDFILE="/opt/var/run/keenetic-tg-bot.pid"
LOGFILE="/opt/var/log/keenetic-tg-bot.log"

PY="/opt/bin/python3"
[ -x "$PY" ] || PY="$(command -v python3 2>/dev/null || echo python3)"

export BOT_CONFIG="$CONFIG1"
[ -f "$BOT_CONFIG" ] || export BOT_CONFIG="$CONFIG2"
export PYTHONUNBUFFERED=1

start() {
  mkdir -p /opt/var/run /opt/var/log
  if [ -f "$PIDFILE" ] && kill -0 "$(cat "$PIDFILE" 2>/dev/null)" 2>/dev/null; then
    echo "Already running"
    return 0
  fi

  if [ -f "$MAIN" ]; then
    BOT="$MAIN"
  else
    BOT="$LEGACY"
  fi

  [ -f "$BOT" ] || { echo "Bot file not found: $BOT"; return 1; }
  [ -f "$BOT_CONFIG" ] || { echo "Config not found: $BOT_CONFIG"; return 1; }

  if command -v nohup >/dev/null 2>&1; then
    nohup "$PY" "$BOT" >> "$LOGFILE" 2>&1 &
  else
    "$PY" "$BOT" >> "$LOGFILE" 2>&1 &
  fi
  echo $! > "$PIDFILE"
  echo "Started PID $(cat "$PIDFILE")"
}

stop() {
  if [ -f "$PIDFILE" ]; then
    PID="$(cat "$PIDFILE" 2>/dev/null)"
    kill "$PID" 2>/dev/null || true
    sleep 1
    kill -9 "$PID" 2>/dev/null || true
    rm -f "$PIDFILE"
  fi
  echo "Stopped"
}

restart() {
  stop
  start
}

status() {
  if [ -f "$PIDFILE" ] && kill -0 "$(cat "$PIDFILE" 2>/dev/null)" 2>/dev/null; then
    echo "RUNNING PID $(cat "$PIDFILE")"
    exit 0
  fi
  echo "STOPPED"
  exit 3
}

case "$1" in
  start|stop|restart|status) "$1" ;;
  *) echo "Usage: $0 {start|stop|restart|status}"; exit 2 ;;
esac
