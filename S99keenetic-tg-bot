#!/bin/sh
export PATH="/opt/sbin:/opt/bin:/usr/sbin:/usr/bin:/sbin:/bin:$PATH"

CFG_DIR="/etc/keenetic-tg-bot"
[ -f "$CFG_DIR/bot.py" ] || CFG_DIR="/opt/etc/keenetic-tg-bot"

BOT="$CFG_DIR/bot.py"
CONFIG="$CFG_DIR/config.json"

PIDFILE="/opt/var/run/keenetic-tg-bot.pid"
LOGFILE="/opt/var/log/keenetic-tg-bot.log"

PY="/opt/bin/python3"
[ -x "$PY" ] || PY="$(command -v python3 2>/dev/null || echo python3)"

export BOT_CONFIG="$CONFIG"
export PYTHONUNBUFFERED=1

start() {
  mkdir -p /opt/var/run /opt/var/log

  [ -f "$BOT" ] || { echo "Bot file not found: $BOT"; return 1; }
  [ -f "$CONFIG" ] || { echo "Config not found: $CONFIG"; return 1; }

  if [ -f "$PIDFILE" ] && kill -0 "$(cat "$PIDFILE" 2>/dev/null)" 2>/dev/null; then
    echo "Already running"
    return 0
  fi

  if command -v nohup >/dev/null 2>&1; then
    nohup "$PY" "$BOT" >> "$LOGFILE" 2>&1 &
  elif command -v setsid >/dev/null 2>&1; then
    setsid "$PY" "$BOT" >> "$LOGFILE" 2>&1 &
  else
    "$PY" "$BOT" >> "$LOGFILE" 2>&1 &
  fi

  echo $! > "$PIDFILE"
  echo "Started PID $(cat "$PIDFILE")"
}

stop() {
  if [ -f "$PIDFILE" ]; then
    PID="$(cat "$PIDFILE" 2>/dev/null)"
    kill "$PID" 2>/dev/null || true
    sleep 1
    kill -9 "$PID" 2>/dev/null || true
    rm -f "$PIDFILE"
  fi
  echo "Stopped"
}

status() {
  if [ -f "$PIDFILE" ] && kill -0 "$(cat "$PIDFILE" 2>/dev/null)" 2>/dev/null; then
    echo "RUNNING PID $(cat "$PIDFILE")"
    return 0
  fi
  echo "STOPPED"
  return 3
}

restart() {
  stop
  start
}

case "$1" in
  start) start ;;
  stop) stop ;;
  restart) restart ;;
  status) status ;;
  *) echo "Usage: $0 {start|stop|restart|status}"; exit 2 ;;
esac
